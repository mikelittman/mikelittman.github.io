<!doctype html>
<html lang="en">
    <head>
        <title>Inventory Manager</title>
        <link href='http://fonts.googleapis.com/css?family=Lato:300,400,700' rel='stylesheet' type='text/css'>
        <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <style>
            html{
                height: 100%;
                width: 100%;
                margin: 0;
                padding: 0;
                font-family: 'Lato', 'Helvetica Neue', sans-serif;
            }
            body{
                margin: 0;
                padding: 0;
                background-color: rgba(200,200,200,.5);
            }
            .content{
                max-width: 600px;
                margin: auto;
            }
            .import{
                height: 100px;
            }
            textarea{
                height: 100%;
                width: 100%;
            }
            .buttons{
                padding: 10px;
            }
            .panes .pane{
                vertical-align: top;
                display: inline-block;
                width: 290px;
            }
            .hide{
                visibility: hidden;
                display: none;
            }
            footer{
                display: block;
                text-align: right;
                color: rgb(50,50,50);
                opacity: 0.3;
                font-size: 10pt;
            }

            .locked{
                opacity: 0.75;
                color: red;
                background-color: rgba(200,0,0,0.3);
            }

            ul{
                padding-left: 0;
            }
            ul li{
                list-style-type: none;
            }

        </style>
    </head>
    <body>
        <div class="content">
            <h2>Inventory Manager</h2>
            <div class="import">
                <textarea id="jsonField" placeholder="Put import JSON here"></textarea>
            </div>
            <br>
            <div class="buttons">
                <button id="refreshInventory"><i class="fa fa-refresh"></i> Refresh Inventory</button>
                <button id="importSettings"><i class="fa fa-arrow-circle-down"></i> Import</button>
                <button id="exportSettings"><i class="fa fa-arrow-circle-up"></i> Export</button>
                <button id="trashCache"><i class="fa fa-trash"></i> Empty Cache</button>
                <!-- <button id="newTheme"><i class="fa fa-plus"></i> New</button> -->
            </div>
            <br>
            <div class="panes">
                <div class="pane">
                    <input id="inventoryFilter" placeholder="Filter">
                    <div>
                        <button id="inventoryClear"><i class="fa fa-eraser"></i> Clear</button>
                        <!-- <button id="inventoryAdd"><i class="fa fa-arrow-circle-right"></i> Add</button> -->
                    </div>
                    <h4>Inventory</h4>
                    <ul id="inventoryList"></ul>
                </div>
                <div class="pane">
                    <div>
                        <select id="themeList">
                            <option>
                                Select a theme
                            </option>
                        </select>
                        <button id="themeSave"><i class="fa fa-save"></i> Save</button>
                    </div>

                    <br>
                    <input placeholder="Theme Name" id="themeName">
                    <br>
                    <div>
                        <h4>Jetpack</h4>
                        <div>
                            <span>Diffuse</span>
                            <select class="textureList" id="jetpackDiffuse"></select>
                            <i class="fa fa-lock"><input class="textureLock" type="checkbox" id="jDLock"></i>
                        </div>
                        <div>
                            <span>Normal</span>
                            <select class="textureList" id="jetpackNormal"></select>
                            <i class="fa fa-lock"><input class="textureLock" type="checkbox" id="jNLock"></i>
                        </div>
                        <div>
                            <span>Specular</span>
                            <select class="textureList" id="jetpackSpecular"></select>
                            <i class="fa fa-lock"><input class="textureLock" type="checkbox" id="jSLock"></i>
                        </div>
                        <h4>Wings</h4>
                        <div>
                            <span>Diffuse</span>
                            <select class="textureList" id="wingsDiffuse"></select>
                            <i class="fa fa-lock"><input class="textureLock" type="checkbox" id="wDLock"></i>
                        </div>
                        <div>
                            <span>Normal</span>
                            <select class="textureList" id="wingsNormal"></select>
                            <i class="fa fa-lock"><input class="textureLock" type="checkbox" id="wNLock"></i>
                        </div>
                        <div>
                            <span>Specular</span>
                            <select class="textureList" id="wingsSpecular"></select>
                            <i class="fa fa-lock"><input class="textureLock" type="checkbox" id="wSLock"></i>
                        </div>
                    </div>
                </div>
            </div>
            <footer>
                &copy; Mike Littman 2015
            </footer>
        </div>
        <script src="/assets/js/libs/jquery-2.1.3.min.js"></script>
        <script>
            $(function(){
                var makeRequest = function(params){
                    var request = window.location.hash.substr(1) + '?' + JSON.stringify(params);
                    var script = document.createElement('script');
                    script.src = request;
                    document.body.appendChild(script);
                };

                window.invCache = {};
                window.themeConfig = {};

                //Load cache
                if(window.localStorage){
                    var cache = window.localStorage.getItem('themeConfig');
                    if(cache && cache !== ""){
                        window.themeConfig = JSON.parse(cache);
                    }
                }

                window.renderItems = function(){
                    var list = $('#inventoryList'),
                        tList = $('.textureList');

                    list.html('');
                    tList.html('');
                    for(var item in window.invCache.items){
                        list.append(
                            $('<li>')
                                .attr('searchKey', item.toLowerCase())
                                // .append(
                                //     $('<input>')
                                //         .attr('type', 'checkbox')
                                //         .attr('uuid', window.invCache.items[item])
                                // )
                                .append(item)
                            );

                        tList.append(
                            $('<option>')
                                .text(item)
                                .attr('searchKey', item.toLowerCase())
                                .attr('value', window.invCache.items[item])
                        );
                    }
                };



                window.refreshThemes = function(){
                    var list = $('#themeList');
                    $('#themeList option:not(:first-child)').remove();
                    for(var theme in window.themeConfig){
                        var doc = window.themeConfig[theme];
                        list.append(
                            $(document.createElement('option'))
                                .attr('value', theme)
                                .text(theme)
                        );
                    }
                };


                window.saveCache = function(){
                    if(window.localStorage){
                        window.localStorage.setItem('themeConfig', JSON.stringify(window.themeConfig));
                    }
                };


                window.refreshThemes();


                window.doThing = function(doc){
                    var request = doc.request;
                    if(request){
                        if(request == "gotInventory"){
                            var items = doc.items;
                            invCache.items = items;
                            window.renderItems();
                            $('#themeList').trigger('change');
                        }
                    }
                };

                $('#trashCache').click(function(){
                    if(confirm("Are you sure you want to empty local cache?")){
                        window.localStorage.clear();
                    }
                });

                $('#exportSettings').click(function(){
                    $('#jsonField').val(JSON.stringify(window.themeConfig));
                });

                $('#importSettings').click(function(){
                    var text = $('#jsonField').val();
                    $.extend(true, window.themeConfig, JSON.parse(text));
                    window.saveCache();
                });

                $('.textureLock').change(function(){
                    var selector = $(this).parent().parent().find('.textureList');
                    if(this.checked){
                        selector.addClass('locked');
                    }
                    else{
                        selector.removeClass('locked');
                    }
                });

                $('#themeList').change(function(){
                    var theme = $(this).val(),
                        data = window.themeConfig[theme]
                        ;

                    $.extend(true, data, {j:{}, w:{}});

                    $('#themeName').val(theme);
                    $('#jetpackDiffuse').val(data.j.d);
                    $('#jetpackNormal').val(data.j.n);
                    $('#jetpackSpecular').val(data.j.s);
                    $('#wingsDiffuse').val(data.w.d);
                    $('#wingsNormal').val(data.w.n);
                    $('#wingsSpecular').val(data.w.s);
                });

                $('#themeSave').click(function(){
                    var name = $('#themeName'),
                        nameVal = name.val().trim()

                        ;

                    if(nameVal === ""){
                        alert("Cannot add theme, we need a name!");
                    }
                    else{
                        window.themeConfig[nameVal] = {
                            j:{
                                d: $('#jetpackDiffuse').val(),
                                n: $('#jetpackNormal').val(),
                                s: $('#jetpackSpecular').val()
                            },
                            w:{
                                d: $('#wingsDiffuse').val(),
                                n: $('#wingsNormal').val(),
                                s: $('#wingsSpecular').val()
                            }
                        };

                        alert(nameVal + " saved!");
                        window.refreshThemes();
                        window.saveCache();
                    }
                });

                $('#inventoryClear').click(function(){
                    $('#inventoryList li input[type="checkbox"]')
                        .removeAttr('checked');
                });

                $('#refreshInventory').click(function(){
                    makeRequest({'request': 'getInventory'});
                });

                $('#inventoryFilter').on('keyup', function(){
                    var val = $(this).val().trim(),
                        search = '[searchKey*="'+val.toLowerCase()+'"]',
                        selector = '#inventoryList li';
                    $(selector).removeClass('hide');
                    $('.textureList option').removeClass('hide');
                    if(val !== ""){
                        $(selector).addClass('hide');
                        $('.textureList option').addClass('hide');
                        $(selector+search).removeClass('hide');

                        $('.textureList option'+search).removeClass('hide');
                        $('.textureList:not(.locked)').each(function(){
                            var list = $(this),
                                options = list.find(':not(.hide)');

                            options.removeAttr('selected');
                            options.first().attr('selected','selected');
                        });
                    }
                });
            });
        </script>
    </body>
</html>
